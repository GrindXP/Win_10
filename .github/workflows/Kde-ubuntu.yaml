name: ubuntu latest

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  xfce-desktop:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up /mnt storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          mkdir -p /mnt/storage/android-sdk
          mkdir -p /mnt/storage/android-avd
          mkdir -p /mnt/storage/android-studio
          df -h /mnt
          
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true
          ls -la /dev/kvm

      - name: Install XFCE Desktop
        run: |
          echo "Installing XFCE (Lightweight Desktop) ðŸ–¥ï¸"
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xfce4-terminal \
            firefox dbus-x11 fonts-noto-color-emoji \
            wget curl net-tools htop openjdk-17-jdk unzip cpu-checker
          echo "âœ… XFCE installed!"

      - name: Configure User
        run: |
          echo "runner:github2024" | sudo chpasswd
          echo "xfce4-session" | tee ~/.xsession
          chmod 644 ~/.xsession
          echo "âœ… User configured"

      - name: Install Android SDK
        run: |
          cd /mnt/storage/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-*.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          export ANDROID_HOME=/mnt/storage/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          
          yes | cmdline-tools/latest/bin/sdkmanager --licenses
          cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" "platforms;android-34" "build-tools;34.0.0" \
            "emulator" "system-images;android-34;google_apis;x86_64"
          echo "âœ… SDK installed"

      - name: Download Android Studio
        run: |
          cd /mnt/storage/android-studio
          wget -q https://dl.google.com/android/studio/ide-zips/2025.2.1.7/android-studio-2025.2.1.7-linux.tar.gz || exit 0
          tar -xzf android-studio-*.tar.gz --strip-components=1 2>/dev/null || exit 0
          rm -f android-studio-*.tar.gz
          echo "âœ… Android Studio Otter 2025.2.1 ready at /mnt/storage/android-studio"

      - name: Setup Environment
        run: |
          mkdir -p ~/.profile.d
          cat > ~/.profile.d/android.sh << 'EOF'
          export ANDROID_HOME=/mnt/storage/android-sdk
          export ANDROID_SDK_ROOT=/mnt/storage/android-sdk
          export ANDROID_AVD_HOME=/mnt/storage/android-avd
          export ANDROID_EMULATOR_HOME=/mnt/storage/android-avd
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:/mnt/storage/android-studio/bin
          EOF
          
          # Load environment for current session
          source ~/.profile.d/android.sh
          
          # Add to bashrc for persistence
          echo "source ~/.profile.d/android.sh" >> ~/.bashrc

      - name: Install xrdp for RDP
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xrdp
          sudo adduser xrdp ssl-cert
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          echo "âœ… xRDP installed and started"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "âœ… Tailscale installed"

      - name: Authenticate Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --accept-routes --accept-dns --ssh
          sleep 3
          echo "âœ… Tailscale authenticated"

      - name: Display Info
        run: |
          TAILSCALE_IP=$(tailscale ip -4)
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ”— Tailscale IP: $TAILSCALE_IP    â•‘"
          echo "â•‘  ðŸ–¥ï¸  RDP Port: 3389                      â•‘"
          echo "â•‘  ðŸ‘¤ Username: runner                     â•‘"
          echo "â•‘  ðŸ”‘ Password: github2024                 â•‘"
          echo "â•‘  ðŸ“± Android Studio: /mnt/storage/android-studio â•‘"
          echo "â•‘  ðŸ“‚ AVD Location: /mnt/storage/android-avd      â•‘"
          echo "â•‘  ðŸ’» Desktop: XFCE (Lightweight)          â•‘"
          echo "â•‘  ðŸ’¾ OS: Ubuntu 24.04                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Connect via RDP: $TAILSCALE_IP:3389"
          echo "Access only through Tailscale network"

      - name: Keep Alive
        run: |
          while true; do
            # Check xrdp service
            if ! sudo systemctl is-active --quiet xrdp; then
              echo "âš ï¸ xRDP down, restarting..."
              sudo systemctl restart xrdp
            fi
            
            # Check Tailscale
            if ! pgrep -f "tailscaled" > /dev/null; then
              echo "âš ï¸ Tailscale down, restarting..."
              sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --accept-routes --accept-dns --ssh
            fi
            
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "N/A")
            echo "âœ… $(date '+%H:%M:%S') - Services Active | Tailscale: $TAILSCALE_IP | RDP: 3389"
            sleep 180
          done
-
